<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> PHPDaemon 异步编程 · Bhe's Blog</title><meta name="description" content="PHPDaemon 异步编程 - Bhe Hongtyu"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://hitsmaxft.github.io/atom.xml" title="Bhe's Blog"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Bhe's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/hitsmaxft" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/hitsmaxft" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">PHPDaemon 异步编程</h1><div class="post-info">Mar 24, 2014</div><div class="post-content"><p>phpdaemon, 基于异步网络请求的应用服务框架</p>
<p>一直以来, php给人的印象就是一个单进程同步的编程语言, 其魅力在于简单, 直观,<br>学习成本低, 容易上手, 所以市场占有率很高.</p>
<p>流行的php模式, 从几年前的 apache + mod-php, 到今天的nginx + php-fpm,<br>在php编程层面上都是一直的.<br>开发者的开发的代码都是居于”php进程会同步执行所有的代码逻辑之后退出并释放”<br>这么一种假设, 不用考虑多线程的锁问题, 大多数情况下也不用考虑内存泄露.<br>虽然实际情况下, php进程受上层管理界面的影响, 并不是像 cli<br>模式那样执行一次并退出, 但对开发者而言, 其中细节可以忽略.</p>
<p>回到 phpdaemon 本身吧,<br>phpdaemon是一个在event和eio两个pecl扩展之上开发的异步网络框架, 类似于 python<br>中的 tornado , 它采用的单进程单线程异步IO的网络模型,<br>可用于开发异步非阻塞的应用.</p>
<p>前面说 phpdaemon 是单进程单线程的网络模式, 严’意义上讲是指它的worker. phpdaemon<br>以 master + workers 方式运行, master只负责分发任务, 在worker<br>进程才进行请求内容的处理工作.</p>
<p>在 phpdaemon 中, 一个进程中会启用多个服务实例,  每个实例对应一个 appinstance.<br>开发者将不同的处理逻辑封装成为不同的 app, 在异步调度中各司其职.</p>
<p>master 在接受到请求之后, 向 AppResolver 发起查询, Resolve 根据上下文,<br>返回一个对应的应用实例名称. 比如需要返回一个静态文件, 那么可以返回一个<br>FileReader 实例, 实例的Request 方法中完成异步并向客户端输出文件内容.<br>而最常见的任务是返回一个动态页面的内容, 这种类型的任务, 在 phpdaemon 中抽象为<br>HttpRequest 类型.   一个常规cms中的前端和后台界面,<br>可以分装成两个不同的appInstance, 在resolver实现对应的判断逻辑,<br>正确路由到对应的appInstance上, 然后再决定发起哪一个 Request 类型.</p>
<p>这种关系有点像 MVC 框架中的C. 大部分php web 框架的 controller<br>中会包含多个action, 在 phpdaemon 中, <code>PHPDaemon\Core\AppInstance</code><br>可以认为是controller, 而action则对应着 client\Request.</p>
<p>为什么这里要分成 AppInstance 和 Request 两种类型呢?<br>这里涉及到并发环境中的内存管理问题. 常规的php应用是同步的, 从来不考虑这个问题.<br>一个实例最终会被释放, 多个请求之间并没有共享关系. 但是在phpdaemon中,<br>并不是这么回事. worker进程一段时间内一直驻留内存, 需要管理每次请求中用到的资源. </p>
<p>服务器的配置是不变的, 可以常驻内存. 对下层接口的调用结果, 不同任务之间是独立的,<br>所以任务完毕后应该释放掉.   </p>
<p>所以, 在并发环境下, AppInstance 不断生成新的 Request<br>对象处理任务并存储在队列当中, 而 Request 在进行网络请求的时,<br>会交出cpu并进入休眠, 等待io事件将自己唤醒. 当 Request 完成任务并返回结果,<br>AppInstance 将结果返回, 并将该 Request 实例从内存中释放.</p>
<p>上文提到的 Request , 并不是一般认为的 网络请求, 而是对应负责处理网络请求的<br>Service. 那么应用的网络请求又是如何发起的呢?</p>
<p>这里先解释下 phpdaemon 中的 pool 和 connection.</p>
<p>Connection, 顾名思义, 就是php代码中发起的异步网络请求, 比如常见的 curl.<br>在异步请求中, 应用发起很多网络请求, 通过事件进行调度.<br>所以同一时间存在多个网络请求, 只不过有的是活跃状态, 有的挂起等待后端返回.<br>存储和管理这些 Connection 的负责人, 就是 Pool. 这就是常说的连接池.</p>
<p>Java语言中的连接池, 一般通过多线程实现的. 而 PhpDaemon 中的连接池,<br>则是在libevent上实现的单进程单线程异步连接池.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2014/06/04/some-words-about-the-new-ios/" class="prev">PREV</a><a href="/2014/03/23/introduction-to-vim/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2023 <a href="https://hitsmaxft.github.io">Bhe Hongtyu</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>