<!DOCTYPE html>
<html lang="zh_CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="uLR4tiR7G944Hw8MS8h3bqSW0xN_C1OlwZwhiWplfWI">
  <meta name="baidu-site-verification" content="codeva-idh14paPwc">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CLXGW+wenkai:300,300italic,400,400italic,700,700italic%7CLXGW+WenKai+Lite:300,300italic,400,400italic,700,700italic%7CPingFang+SC:300,300italic,400,400italic,700,700italic%7CMicrosoft+YaHei:300,300italic,400,400italic,700,700italic%7Csans-serif:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"io.bhe.ink","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":true,"i18n":{"placeholder":"بحث...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Bhe&#39;s Blog">
<meta property="og:url" content="https://io.bhe.ink/index.html">
<meta property="og:site_name" content="Bhe&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Bhe Hongtyu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://io.bhe.ink/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh_CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Bhe's Blog - Bhe's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-42604344-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-42604344-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Bhe's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="تشغيل شريط التصفح" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Bhe's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Bhe's Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="بحث" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>الأرشيفات</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>الوسوم</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>التصنيفات</a></li>
  </ul>
</nav>



  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          المحتويات
        </li>
        <li class="sidebar-nav-overview">
          عام
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Bhe Hongtyu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">المقالات</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">التصنيفات</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">الوسوم</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hitsmaxft" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hitsmaxft" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/hitsmaxft" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;hitsmaxft" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://io.bhe.ink/2023/06/17/Getting-Started-with-Nix-Language-A-Beginner-s-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bhe Hongtyu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bhe's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Bhe's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/17/Getting-Started-with-Nix-Language-A-Beginner-s-Guide/" class="post-title-link" itemprop="url">Nix 语言初学者上手指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2023-06-17 14:10:38" itemprop="dateCreated datePublished" datetime="2023-06-17T14:10:38+00:00">2023-06-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2023-06-24 15:58:45" itemprop="dateModified" datetime="2023-06-24T15:58:45+00:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/nix/" itemprop="url" rel="index"><span itemprop="name">nix</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2023/06/17/Getting-Started-with-Nix-Language-A-Beginner-s-Guide/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2023/06/17/Getting-Started-with-Nix-Language-A-Beginner-s-Guide/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于前阵子 MacBookPro 重新格式化了, 于是用 <code>nix-darwin</code> 和 <code>home-manager</code> 重新构建了自己的配置管理. 这里写一篇文章记录一些个人对 nix 的学习和总结</p>
<h2 id="运行环境和工具"><a href="#运行环境和工具" class="headerlink" title="运行环境和工具"></a>运行环境和工具</h2><p>nix 本身是一个语言和包管理工具, 完整的 nix os 体验需要安装的它的发行版, 但个人觉得没必要. nix 也可以在其他 <code>类 Unix</code> 系统中使用, 作为系统自带包管理系统的补充.</p>
<p>首先需要安装基础的 nix 环境, </p>
<blockquote>
<p><code>nix</code> 安装手册 <a target="_blank" rel="noopener" href="https://github.com/NixOS/nix#installation">https://github.com/NixOS/nix#installation</a></p>
<p>MacOS 用户可以选择安装 <a target="_blank" rel="noopener" href="https://github.com/LnL7/nix-darwin">https://github.com/LnL7/nix-darwin</a> , 启用系统级的 Nix 集成</p>
<p>其他 Linux 发行版, 或者 <code>wsl2</code> 用户, 可以通过 <code>home-manager</code>, 管理当前 <code>Home</code> 目录下的 rc 文件和环境变量,<br>起到和 <code>homebrew</code> 等价的效果</p>
</blockquote>
<p>安装完毕需要修改默认配置  <code>~/.config/nix/nix.conf</code>  启用 nix-command 和 flakes</p>
<blockquote>
<p>我的本机环境是 <code>mac</code> , 这里授权了 <code>staff</code> 组的用户使用 nix (否则在访问 nix-daemon 的时候报没有权限之类的错误)<br>对于其他环境, 可以改成 <code>sudoers</code> 或者其他组名.</p>
</blockquote>
<pre class="language-none"><code class="language-none">experimental-features &#x3D; nix-command flakes
allowed-users &#x3D; @staff
trusted-users &#x3D; @staff</code></pre>

<p>以下是可选部分, 使用国内镜像等</p>
<pre class="language-none"><code class="language-none">trusted-substituters &#x3D; https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;nix-channels&#x2F;store
substituters &#x3D; https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;nix-channels&#x2F;store https:&#x2F;&#x2F;cache.nixos.org</code></pre>

<p>执行 nix 脚本, 有以下两种方式</p>
<ul>
<li><code>nix eval</code>  直接执行表达式,在测试函数的时候非常方便</li>
<li><code>nix repl</code> import 文件执行看结果, 交互式 shell 方便<ul>
<li>在表达式之前加 <code>:p</code> 可以禁用 lazy eval, 看到最终结果</li>
<li>执行 <code>:help</code> 可以看到更多例子</li>
</ul>
</li>
</ul>
<p>举个 <code>nix eval</code> 的简单例子, 可以用这种方式测试本文中的其他例子.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">nix eval --expr &#39;1+1&#39;
nix eval --expr &#39;[ 1 2 3 4]&#39;</code></pre>

<h2 id="从零熟悉-nix-lang-的基本元素"><a href="#从零熟悉-nix-lang-的基本元素" class="headerlink" title="从零熟悉 nix-lang 的基本元素"></a>从零熟悉 nix-lang 的基本元素</h2><p>由于 nix 是函数式语言, 首先需要熟悉它的核心概念 <code>表达式</code></p>
<h2 id="函数式和表达式"><a href="#函数式和表达式" class="headerlink" title="函数式和表达式"></a>函数式和表达式</h2><p>首先看一下一个 nix 表达式的组成部分</p>
<ul>
<li><code>with</code>  引入命名空间部分</li>
<li><code>let ... in</code> 变量声明部分</li>
<li>表达式实际内容</li>
</ul>
<pre class="language-nix" data-language="nix"><code class="language-nix">
## with; 命名空间
with import &lt;nixpkgs&gt; &#123;&#125;;
with libs;

## 定义变量和新函数; 每个语句以 &#96;;&#96; 结束
let
	a &#x3D;1 ;
	join &#x3D; (strs: conatStringSep &quot;&quot; strs);
in
	join [ &quot;a&quot; &quot;b&quot; &quot;c&quot; ]  # 表达式不需要 &#96;;&#96;&#96; 结尾
	</code></pre>

<p>with 语句在当前表达式作用域 (<code>scope</code> ) 中直接使用它的内部属性&#x2F;方法, 可以减少代码长度.</p>
<pre class="language-none"><code class="language-none">&#x2F;*改写前*&#x2F;
builtins.concatStringsSep &quot;,&quot; (builtins.map (p : &quot;v&quot;+p) [ &quot;1&quot; &quot;2&quot; &quot;3&quot; ])
&#x2F;*改写后*&#x2F;
with builtins; concatStringsSep &quot;,&quot; (map (p : &quot;v&quot;+p) [ &quot;1&quot; &quot;2&quot; &quot;3&quot; ])</code></pre>

<p>普通 set 变量也是可以用 <code>with</code>  导入当前 <code>scope</code> </p>
<pre class="language-none"><code class="language-none">let
   values &#x3D; &#123; a &#x3D;1; b&#x3D;2 ;&#125;;
in
   with values ; a+b</code></pre>

<p>这几个元素可以在表达式的内部继续嵌套使用, 举一个嵌套表达式的例子</p>
<pre class="language-none"><code class="language-none">nix-repl&gt; let a &#x3D; [&quot;a&quot;]; in (let b &#x3D; [&quot;b&quot;]; in with lib; a ++ b )
[ &quot;a&quot; &quot;b&quot; ]</code></pre>


<blockquote>
<p>! 但复杂语法深度套娃, 最终结果会非常难读.<br>过度炫技不可取.</p>
</blockquote>
<h3 id="类型和集合"><a href="#类型和集合" class="headerlink" title="类型和集合"></a>类型和集合</h3><h4 id="基本类型"><a href="#基本类型" class="headerlink" title="基本类型"></a>基本类型</h4><p>关于基础类型这里就不展开了, 基本的 <code>bool</code>, <code>int</code>, <code>string</code> 和大部分语言差异不大.</p>
<blockquote>
<p>见 <a target="_blank" rel="noopener" href="https://nixos.org/manual/nix/stable/language/values.html">https://nixos.org/manual/nix/stable/language/values.html</a></p>
</blockquote>
<h4 id="集合类型"><a href="#集合类型" class="headerlink" title="集合类型"></a>集合类型</h4><p>在 nix 里 集合类型主要需要了解 <code>lists</code> 和 <code>sets</code> ( <code>attribute set</code>)</p>
<ul>
<li>list : 数组类型</li>
<li>set : 字典或者 map</li>
</ul>
<pre class="language-nix" data-language="nix"><code class="language-nix">[ &quot;one&quot; &quot;two&quot; &quot;three&quot; ]

&#123; key1 &#x3D; &quot;value1&quot;; key2 &#x3D; &quot;value2&quot;; &#125;</code></pre>


<blockquote>
<p>在写 nix 的过程中, 我个人经常会感到对 集合语法上的不适应, 主要原因是它在语法上和其他语言存在差异. 大部分时候, 我总感觉如果 nix 使用 <code>,</code> 作为分隔符对其他语言的使用者来说会更容易习惯.<br>nix wiki 也提到, 在 <code>nix</code>  中 ‘;’ 扮演了其他语言中 <code>,</code> 的角色. 所以在 nix 没有出现 <code>,</code> 是因为已经选择了 <code>;</code> </p>
</blockquote>
<pre class="language-nix" data-language="nix"><code class="language-nix"># 数组成员间不需要 &#96;;&#96; 隔开, 也不要习惯性地使用 &#96;,&#96;
alist &#x3D; [ 1 2 3 ]  ; 

# 见 https:&#x2F;&#x2F;nixos.org&#x2F;guides&#x2F;nix-pills&#x2F;basics-of-language.html#idm140737320545296

# set 成员需要 &#96;;&#96; 分隔
aSet &#x3D; &#123;
 a &#x3D; [];
 b &#x3D; &quot;strs&quot;;
 c &#x3D; 1;
&#125;;
# 更多例子见 https:&#x2F;&#x2F;nixos.org&#x2F;guides&#x2F;nix-pills&#x2F;basics-of-language.html#idm140737320542544</code></pre>

<p>还有其他类型</p>
<ul>
<li>string <a target="_blank" rel="noopener" href="https://nixos.org/guides/nix-pills/basics-of-language.html#idm140737320577792">https://nixos.org/guides/nix-pills/basics-of-language.html#idm140737320577792</a></li>
<li>derivation <a target="_blank" rel="noopener" href="https://nixos.org/guides/nix-pills/our-first-derivation.html">https://nixos.org/guides/nix-pills/our-first-derivation.html</a> 关于 derivation , 需要很长的展开, 篇幅原因这里就先跳过了.</li>
<li>URL 和 Path  也很重要, 但这块后面写包管理的时候再展开了.</li>
</ul>
<p>更多常见类型, 见官方 wiki , <a target="_blank" rel="noopener" href="http://www.binaryphile.com/nix/2018/07/22/nix-language-primer.html">http://www.binaryphile.com/nix/2018/07/22/nix-language-primer.html</a></p>
<h3 id="函数基础"><a href="#函数基础" class="headerlink" title="函数基础"></a>函数基础</h3><h3 id="无名参数函数-nameless-parameter-function"><a href="#无名参数函数-nameless-parameter-function" class="headerlink" title="无名参数函数(nameless parameter function)"></a>无名参数函数(nameless parameter function)</h3><p>最基础的函数定义 (传统函数风格) ,  使用参数按顺序传入</p>
<blockquote>
<p>函数定义的风格写法有好几种, 个人建议定义函数使用第一种或者第二种<br>调用语法, 个人习惯第一种,  <code>()</code> 使用多了会导致语句不易读, 陷入了 LISP 语法的笑话</p>
</blockquote>
<pre class="language-nix" data-language="nix"><code class="language-nix">let
  plus &#x3D; (a: b: a + b ); 
  plus2 &#x3D; a: b: a+b;
  plus3 &#x3D; (a: (b: a+b));
  plus4 &#x3D; a: (b: a+b);
in  (plus 1 2) + plus2 (1) (2)  + plus3(1) 2
#&gt;&gt; 9</code></pre>

<p>作为函数式语言, 不难发现 nix 也是支持 curry 的.</p>
<pre class="language-nix" data-language="nix"><code class="language-nix">let
 plus &#x3D; a: b: a+b;
 plus1 &#x3D; plus(1);
in
 plus1(plus1(2))

#&gt;&gt; 4</code></pre>

<blockquote>
<p>由于  <code>:</code> 后面的函数体是一个表达式, 因此可以加入 <code>let ... in</code>  定义中间变量.</p>
</blockquote>
<blockquote>
<p>另外, 在中间语句中加入 with 也是很常见的, 大部分库代码或者包描述中都可以看到.</p>
</blockquote>
<pre class="language-nix" data-language="nix"><code class="language-nix">let
  values &#x3D; &#123; c&#x3D;2; &#125;;
  plus1 &#x3D; a: with values; let b&#x3D;1; in a+b+c;
in
  plus1 2

#&gt;&gt; 3</code></pre>

<p>好了, 表达式函数的特性, nix 和其他语言的差异不是很明显, 唯一特别的就是在其他语言中, 一般我们只会看到 <code>&#123;param1, ...&#125; : expr</code> 这样的 函数定义.</p>
<p>比如 这段 scala 代码. </p>
<pre class="language-scala" data-language="scala"><code class="language-scala">
import my;
def myFunction(param1: Int, param2: Int): Int &#x3D; &#123;
  val a &#x3D; my.param3 * my.param4
  param1 + param2 + a
&#125;</code></pre>
<p>通过 nix 的书写,往往比较紧凑</p>
<pre class="language-nix" data-language="nix"><code class="language-nix">&#123;
  myFunction &#x3D; &#123;param1, param2&#125;:
    with my;
    let a &#x3D; param3 * param4;
    in param1 + param2 + a 
&#125;</code></pre>

<p>在 nix 中, <code>let ... in expr</code> 和 <code>import ...; expr</code>  和函数签名挤成一堆,  与其他语言略有不同, 需要熟悉一段时间.</p>
<h4 id="命名参数函数"><a href="#命名参数函数" class="headerlink" title="命名参数函数"></a>命名参数函数</h4><p>前面介绍了 <code>nix</code> 中无名参数风格的函数, 类似于 c 或者 <code>java</code> 中的普通函数,<br>接下来介绍在动态语言中很受欢迎的命名函数特性, nix 也同样做了支持.</p>
<blockquote>
<p>相比于<code>无名参数</code>, <code>命名参数</code> 的调用代码可读性更强, 同时方便后期维护, 不会出现一旦修改签名需要大量重构代码的痛苦.</p>
</blockquote>
<p>首先举一个复杂的可变参数长度的例子开场:</p>
<pre class="language-nix" data-language="nix"><code class="language-nix">let func &#x3D; &#123;a, b, c, ...&#125; : a+b+c in  func &#123; a&#x3D;1; b&#x3D;2; c&#x3D;3; d&#x3D;4;&#125;</code></pre>

<p>如果获取可变参数中的变量, 可以通过 <code>@</code> 引用的参数列表, 这里使用 args 作为变量名.</p>
<pre class="language-nix" data-language="nix"><code class="language-nix">let func &#x3D; &#123;a, b, c, ...&#125;@args: a+b+c+args.d; in  func &#123; a&#x3D;1; b&#x3D;2; c&#x3D;3; d&#x3D;4;&#125;</code></pre>

<p>通过nix 的 <code>命名参数</code> 函数定义可以看出来, 类似于把函数的传入参数变成一个 attribute set.</p>
<p>等价于单参数的函数的一个语法糖,以下举几个例子, 函数 <code>fun</code> 采用了<code>无名参数</code>, 但使用效果和<code>命名参数</code>是一样的.</p>
<blockquote>
<p><code>let fun = p:  with p ; a+b ; in fun &#123; a=1; b=2;&#125;</code><br>等价于  <code>let fun = &#123; a, b &#125;: a+b ; in fun &#123; a=1; b=2;&#125;</code></p>
<p><code>let fun = p:  with p ; a+b+p.c ; in fun &#123; a=1; b=2; c=3;&#125;</code><br>等价于  <code>let fun = &#123; a, b &#125;@args : a+b+args.c ; in fun &#123; a=1; b=2; c=3; &#125;</code></p>
</blockquote>
<p>可能由于大量同名赋值的存在, <code>nix</code> 还提供了 <code>inherit</code>  关键字, 简化了形参的代码书写.</p>
<blockquote>
<p><code>inherit</code> 关键字可以起到类似 <code>with</code> 的作用, 省掉了把同名参数写一遍的功夫</p>
</blockquote>
<pre class="language-nix" data-language="nix"><code class="language-nix">let
  fun &#x3D; &#123; a, b &#125;: a+b;
  attrs &#x3D; &#123; a &#x3D;1 ; b&#x3D;2; &#125;;
in fun &#123; 
	inherit (attrs) a b;
&#125;</code></pre>

<p> 还有另外的写法</p>
<pre class="language-nix" data-language="nix"><code class="language-nix">let
  fun &#x3D; &#123; a, b &#125;: a+b;
  b &#x3D; 2;
in fun &#123; 
	a&#x3D;2;
	inherit b;
&#125;
</code></pre>

<p>回到 <code>命名参数</code> 话题本身</p>
<p>这里举例只是做对比, 既然有语法糖, 直接用比较爽.</p>
<p>相比前面的例子,  使用语言内置命名参数, 比较方便地使用默认参数.</p>
<ul>
<li>默认参数 <code>func = &#123;a, b, c? 3, ...&#125; : a+b+c</code></li>
</ul>
<pre class="language-none"><code class="language-none">:p let
func &#x3D; &#123;a, b, c, ...&#125; : a+b+c;   #可变参数列表
func2 &#x3D; &#123;a, b, c?3 &#125;: a+b+c;
in 
[ func&#123; a&#x3D;1; b&#x3D;2; c&#x3D;3; &#125; func2&#123; a&#x3D;1; b&#x3D;2; &#125; ]</code></pre>

<p>总结一下, 命名形参的函数定义, 相对于匿名参数有以下好处: </p>
<ul>
<li>防止多参数太长不可读</li>
<li>参数支撑默认值</li>
<li>可变参数访问 <code>@xxx</code></li>
</ul>
<blockquote>
<p>更多例子见官方文档  <a target="_blank" rel="noopener" href="https://nixos.org/guides/nix-pills/functions-and-imports.html#idm140737320477216">https://nixos.org/guides/nix-pills/functions-and-imports.html#idm140737320477216</a></p>
</blockquote>
<blockquote>
<p>注意, 不能像 c 语言一样用方括号包裹表达式, 否则就变成了一个返回值为 set 的函数了.</p>
</blockquote>
<pre class="language-none"><code class="language-none">&#123;a, b, c, ...&#125;: &#123;&#125;  #返回值是 set</code></pre>

<h3 id="函数手册"><a href="#函数手册" class="headerlink" title="函数手册"></a>函数手册</h3><p>nix 缺乏一个好的函数查找工具. 目前只能通过文档查找</p>
<ul>
<li><code>builtins.*</code> <a target="_blank" rel="noopener" href="https://nixos.org/manual/nix/stable/language/builtins.html">https://nixos.org/manual/nix/stable/language/builtins.html</a></li>
<li><code>nixpkgs.lib.*</code>  <a target="_blank" rel="noopener" href="https://nixos.org/manual/nixpkgs/stable/#sec-functions-library">https://nixos.org/manual/nixpkgs/stable/#sec-functions-library</a></li>
</ul>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul>
<li>官方手册 <a target="_blank" rel="noopener" href="https://nixos.org/manual/nix/stable/language/index.html">https://nixos.org/manual/nix/stable/language/index.html</a></li>
<li>nix-language-primer <a target="_blank" rel="noopener" href="http://www.binaryphile.com/nix/2018/07/22/nix-language-primer.html">http://www.binaryphile.com/nix/2018/07/22/nix-language-primer.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://io.bhe.ink/2023/06/11/nix-and-home-manager-is-your-best-system-environment-management-solution/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bhe Hongtyu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bhe's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Bhe's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/11/nix-and-home-manager-is-your-best-system-environment-management-solution/" class="post-title-link" itemprop="url">nix and home-manager, 最好的系统环境管理工具</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2023-06-11 11:07:26" itemprop="dateCreated datePublished" datetime="2023-06-11T11:07:26+00:00">2023-06-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2023-06-24 15:58:45" itemprop="dateModified" datetime="2023-06-24T15:58:45+00:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/shell/" itemprop="url" rel="index"><span itemprop="name">shell</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2023/06/11/nix-and-home-manager-is-your-best-system-environment-management-solution/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2023/06/11/nix-and-home-manager-is-your-best-system-environment-management-solution/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>由 chatgpt 生成…</p>
</blockquote>
<p>在当今的技术领域，配置管理变得越来越重要。对于开发者和技术爱好者来说，保持一致的开发环境和工具配置是至关重要的。然而，传统的配置文件管理方式可能会导致配置分散、混乱和难以维护的问题。</p>
<p>幸运的是，有一个强大的工具可以帮助我们解决这些问题，那就是home-manager。Home-manager是一个基于Nix的工具，旨在帮助用户统一管理他们的配置文件，并通过声明性的方式进行配置。</p>
<p>本文将介绍如何安装home-manager以及使用它来管理一些常见的配置文件，例如zsh、bash和vim。我们将探索如何使用home-manager的内置功能和插件来简化配置文件的管理，并介绍如何定制和贡献新的配置。</p>
<p>接下来的内容中, 主要围绕两个工具的使用.</p>
<ul>
<li><code>home-manager</code> 声明式, 函数式, 面向终态的用户配置管理方案</li>
<li>通过 <code>yadm</code> 完成将配置文件同步到 github</li>
</ul>
<h2 id="安装-home-manager"><a href="#安装-home-manager" class="headerlink" title="安装 home-manager"></a>安装 home-manager</h2><p>假设当前系统处于初始化状态, 这里首先更新 channel , 接着安装最新的 home-manager.</p>
<blockquote>
<p>官方安装教程 <a target="_blank" rel="noopener" href="https://nix-community.github.io/home-manager/index.html#sec-install-standalone">https://nix-community.github.io/home-manager/index.html#sec-install-standalone</a><br>可选的方式还有通过 flake 加载.</p>
</blockquote>
<pre class="language-bash" data-language="bash"><code class="language-bash">nix-channel --add https:&#x2F;&#x2F;github.com&#x2F;nix-community&#x2F;home-manager&#x2F;archive&#x2F;master.tar.gz home-manager 
nix-channel --update

nix-shell &#39;&lt;home-manager&gt;&#39; -A install</code></pre>

<p>安装完毕, home-manager 会自动生成一个最小化配置在 <code>~/.config/home-manager/home.nix</code>  这个文件中. 这里 home-manager 的可以告一段落</p>
<blockquote>
<p>官方文档中会提及修改 <code>.profile</code> 等操作. 这部分会在 <code>program</code> 段落中进行.</p>
</blockquote>
<h2 id="通过-yadm-将配置文件同步到-github"><a href="#通过-yadm-将配置文件同步到-github" class="headerlink" title="通过 yadm 将配置文件同步到 github"></a>通过 yadm 将配置文件同步到 github</h2><p>在通过 nix-shell 载入 yadm 和相关软件, 通过执行 <code>nix-shell -p pkg1 pkg2</code> , 可以快速得到临时环境</p>
<blockquote>
<p>假设我们的 dotfiles 将上传到 <code>$GIT_USER</code> 这个用户名下的 <code>dotfiles</code> 仓库.<br>那么 github 全路径为 <code>git@github.com:$&#123;GIT_USER&#125;/dotfiles.git</code></p>
</blockquote>
<pre class="language-bash" data-language="bash"><code class="language-bash">yadm init
yadm add ~&#x2F;.config&#x2F;home-manager&#x2F;home.nix
yadm commit -m &#39;add home.nix&#39;
yadm remote add origin git@github.com:$&#123;GIT_USER&#125;&#x2F;dotfiles.git
</code></pre>

<p>如果仓库中没有任何内容, 这是应该直接推送到 <code>master</code> 分支, (或者 main )</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">yadm push -u origin master</code></pre>

<blockquote>
<p>假设你已经有现成的 dotfiles, 可以直接执行 <code>yadm clone git@github.com:$&#123;GIT_USER&#125;/dotfiles.git</code> 一步初始化</p>
</blockquote>
<h2 id="home-program-声明式管理shell-环境"><a href="#home-program-声明式管理shell-环境" class="headerlink" title="home.program: 声明式管理shell 环境"></a>home.program: 声明式管理shell 环境</h2><p>home-manager 可以用于替代 <code>stow</code> 和 <code>homebrew</code> , 通过在 <code>~/.nix-profile/bin</code> 下加入软链等, 方便地管理当前环境中的各种工具.</p>
<p>对于经常需要修改开发环境的开发者</p>
<p><code>home.programs</code> 内置了大量 常用 shell 命令的配置, 通过这些配置项, 一方面自动化往当前 home.nix 中增加 <code>nix</code> package, 同时还能生成对应的配置文件, 替代手动管理配置文件.</p>
<p>解决了配置文件分散在各个目录和文件下的脏乱差现场, 现在配置文件都托管给了 nix  通过 <code>home-manager</code>  进行集中化管理, 同时<br>社区中大量已经贡献进来的 programs 配置项不仅可以直接使用, 后面会介绍如何通过 <code>import</code> 定制已有的 <code>program</code>. </p>
<blockquote>
<p>当然可以也新增自己的 program 实现, 最后贡献给 <code>home-manager</code> 社区.</p>
</blockquote>
<p>接下来章节中, 首先介绍一些常见场景下的 <code>home-manager</code> 使用案例</p>
<ul>
<li>zsh</li>
<li>bash</li>
<li>vim</li>
</ul>
<h3 id="热身开始-通过-nix-管理-zsh-配置文件"><a href="#热身开始-通过-nix-管理-zsh-配置文件" class="headerlink" title="热身开始, 通过 nix 管理 zsh 配置文件"></a>热身开始, 通过 nix 管理 zsh 配置文件</h3><p>过去配置 zsh, 一般是通过修改 <code>.zshrc</code> <code>.zprofile</code> 和 <code>.zshenv</code> 这些文件, 如果需要同步到不同机器, 可以借助 <code>yadm</code> 同步到 <code>github</code> .</p>
<p>随着 shell 的配置项的代码量不断膨胀, </p>
<p>接下来将介绍如何通过 <code>home-manager</code> 的 <code>programs.zsh</code> 配置项, 声明式管理 zsh 的所有配置文件.</p>
<p>以下是一个 <code>zsh</code> 的配置实例, 内置了一部分常用的 <code>zsh</code> 特性.</p>
<ul>
<li>内置 <code>oh-my-zsh</code> , 启用 <code>vi-mode</code>  和  <code>jump</code> 插件</li>
<li><code>.zshenv</code> 加入 nix 环境变量 (这就是前面安装 nix 环境中跳过的部分)<ul>
<li><code>envExtra</code></li>
</ul>
</li>
<li><code>.zshrc</code>  加入自定义选项<ul>
<li><code>initExtraFirst</code>  这部分脚本会在 .zshrc 最前面, 先于 <code>oh-my-zsh</code> 和其他脚本</li>
<li><code>initExtra</code> 这部分脚本优先级低于其他的</li>
<li><code>initExtraBeforeCompInit</code> 这部分脚本将在 zsh插件 加载之前执行</li>
</ul>
</li>
</ul>
<blockquote>
<p>具体实现见 <a target="_blank" rel="noopener" href="https://github.com/nix-community/home-manager/blob/master/modules/programs/zsh.nix">https://github.com/nix-community/home-manager/blob/master/modules/programs/zsh.nix</a><br>zshrc 配置项大致的优先级为  initExtraFirst &gt;  initExtraBeforeCompInit &gt; plugsin &gt; ohmyzsh &gt; initExtra</p>
</blockquote>
<pre class="language-nix" data-language="nix"><code class="language-nix">&#123;pkg, ...&#125; : 
&#123;
	home.programs &#x3D; &#123;
		zsh &#x3D; &#123;
			enable &#x3D; true;
			oh-my-zsh &#x3D; &#123;
				enable &#x3D; true;
				plugins &#x3D; [
					&quot;vi-mode&quot;
					&quot;jump&quot;
				]
				
			&#125;;
			
			envExtra &#x3D; &#39;&#39;
if [ -e &#39;&#39;$&#123;HOME&#125;&#x2F;.nix-profile&#x2F;etc&#x2F;profile.d&#x2F;nix.sh ]; then . &#39;&#39;$HOME&#x2F;.nix-profile&#x2F;etc&#x2F;profile.d&#x2F;nix.sh; fi # added by Nix installer

			&#39;&#39;;
			initExtraFirst &#x3D; &#39;&#39;
			&#39;&#39;;
			initExtra &#x3D; &#39;&#39;
			&#39;&#39;;


		&#125;;
	&#125;;
&#125;</code></pre>

<h3 id="管理-bash-配置"><a href="#管理-bash-配置" class="headerlink" title="管理 bash 配置"></a>管理 bash 配置</h3><p>接下来是一个 <code>bash</code> 的配置实例.</p>
<p>给 bash 内置了<code>补全</code>功能和 <code>starship</code> (类似 p10k 的 zsh 提示符主题, rust 实现, 需要预先在 packages 中安装)</p>
<pre class="language-nix" data-language="nix"><code class="language-nix">&#123;
	home.packages &#x3D; [

		starship
	];
    programs &#x3D; &#123;
    bash &#x3D; &#123;
        enable &#x3D; true;
        enableCompletion &#x3D; true;
        initExtra &#x3D; &#39;&#39;
          eval &quot;$(starship init bash)&quot;
          &#39;&#39;;
      &#125;;
    &#125;;
&#125;</code></pre>

<p>在 <code>.bashrc</code> 中, 可以看到最终效果为:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">if [[ ! -v BASH_COMPLETION_VERSINFO ]]; then
  . &quot;&#x2F;nix&#x2F;store&#x2F;*******-bash-completion-2.11&#x2F;etc&#x2F;profile.d&#x2F;bash_completion.sh&quot;
fi

# init starship prompt
eval &quot;$(starship init bash)&quot;</code></pre>


<h3 id="管理-vim-配置"><a href="#管理-vim-配置" class="headerlink" title="管理 vim 配置"></a>管理 vim 配置</h3><h3 id="通过-import-管理自定义-program"><a href="#通过-import-管理自定义-program" class="headerlink" title="通过 import 管理自定义 program"></a>通过 <code>import</code> 管理自定义 <code>program</code></h3><p>假设已经开发了一个名叫 <code>xxx</code> 的 program, 放在了 <code>home-manager/modules</code> 配置目录下.</p>
<pre class="language-nix" data-language="nix"><code class="language-nix">#~&#x2F;.config&#x2F;home-manager&#x2F;modules&#x2F;xx.nix
&#123; config, lib, ... &#125;:
let
  cfg &#x3D; config.programs.xxx;
in &#123;
  options.programs.xxx &#x3D; &#123;
    enable &#x3D; lib.mkEnableOption &quot;xxx&quot;;

    settings &#x3D; lib.mkOption &#123;
      default &#x3D; &#123; &#125;;
      type &#x3D; lib.types.attrsOf lib.types.str;
      example &#x3D; lib.literalExpression &#39;&#39;
        &#123;
          XXX_LOADED &#x3D; &quot;yes&quot;;
        &#125;
      &#39;&#39;;
      description &#x3D; lib.mdDoc
        &quot;XXX config&quot;;
    &#125;;
  &#125;;
  config &#x3D; lib.mkIf cfg.enable &#123;
    home &#x3D; &#123;
      sessionVariables &#x3D; cfg.settings;
    &#125;;
  &#125;;
&#125;</code></pre>

<p>接下来需要在 home.nix 中通过 <code>import</code> 导入 <code>xxx</code></p>
<pre class="language-nix" data-language="nix"><code class="language-nix"># home.nix
&#123;&#125;:
&#123;
  imports &#x3D; [ .&#x2F;modules&#x2F;xxx.nix ];

  programs &#x3D; &#123;
    sd &#x3D; &#123;
        enable &#x3D; true;
        settings &#x3D; &#123;
          XXX_LOADED &#x3D; &quot;yes&quot;;
        &#125;;
    &#125;;

  &#125;;
&#125;</code></pre>


<h2 id="通过-overlay-增加自定义函数和应用包"><a href="#通过-overlay-增加自定义函数和应用包" class="headerlink" title="通过 overlay 增加自定义函数和应用包"></a>通过 overlay 增加自定义函数和应用包</h2><p>这里举一个例子, 往 <code>&lt;nixpkgs&gt;</code> 中新增 <code>vim-darwin</code> 包.</p>
<ul>
<li>关闭 GUI </li>
<li>开启 darwin 特性, vim 和 mac 剪贴板交互需要开启该编译选项</li>
<li>内置两个基础插件</li>
</ul>
<pre class="language-nix" data-language="nix"><code class="language-nix"># ~&#x2F;.config&#x2F;home-manager&#x2F;overlays&#x2F;default.nix

final: prev: 
let
	pkgs &#x3D; prev;
in
&#123;
    vim-darwin &#x3D;  pkgs.vim-full.customize &#123;
      vimrcConfig.packages.default &#x3D; &#123;
        gui &#x3D; true;
        darwin &#x3D; true;
        start &#x3D; [
          pkgs.vimPlugins.vim-nix
          pkgs.vimPlugins.vim-plug
        ];
      &#125;;
    &#125;;
&#125;</code></pre>

<p>完成上面的基础 <code>overlays</code> 脚本, 接下来需要在 home-manager 中引用.</p>
<pre class="language-nix" data-language="nix"><code class="language-nix">#  ~&#x2F;.config&#x2F;home-manager&#x2F;home.nix

&#123;pkgs, ...&#125; : &#123;

  nixpkgs.overlays &#x3D; [ 
    (import .&#x2F;overlays&#x2F;default.nix)
  ];

&#125;</code></pre>


<p>再次运行 <code>home-manager switch</code> 完成 <code>overlays</code> 加载</p>
<p>最后, 再次修改 <code>home.nix</code> 的 <code>home.pacakges</code> 完成 <code>vim-darwin</code> 的安装</p>
<pre class="language-nix" data-language="nix"><code class="language-nix">
&#123;pkgs, ...&#125; : &#123;

  nixpkgs.overlays &#x3D; [ 
    (import .&#x2F;overlays&#x2F;default.nix)
  ];

  home.packages &#x3D; [
	vim-darwin
  ]

&#125;
</code></pre>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>就此, 本文总结了大部分常见的 home-manager 配置管理技巧, 更多内容可以参考官方文档 <a target="_blank" rel="noopener" href="https://nix-community.github.io/home-manager/index.html">https://nix-community.github.io/home-manager/index.html</a></p>
<p>相对于手动管理配置文件, 采用 home-manager 有以下几个优点</p>
<ul>
<li>声明式配置 - 使用 home-manager，可以使用 Nix 表达式以声明性的方式定义配置。这样可以实现版本控制、可复现性和易分享的配置。</li>
<li>集中化管理 - home-manager 提供了一种集中管理您的 shell 环境配置的方法，而不是将配置文件分散在不同的目录和文件中。这样可以更容易地维护和更新配置。</li>
<li>模块化, 可复用 - home-manager 以模块化的方式处理配置，允许您根据需要启用或禁用特定的组件或程序。它还提供了许多预配置的程序，可以直接使用或根据需求进行自定义。</li>
<li>支持版本管理 - 由于 home-manager 的配置存储在像 Git 这样的版本控制系统中，您可以轻松跟踪更改、还原到以前的版本，并与他人合作。这在管理 shell 配置时提供了额外的安全性和灵活性</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://io.bhe.ink/2023/04/02/make-debian-bullseye-images-for-rock960c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bhe Hongtyu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bhe's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Bhe's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/02/make-debian-bullseye-images-for-rock960c/" class="post-title-link" itemprop="url">制作 rock960c 的 debian 11  emmc 系统镜像</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2023-04-02 20:02:04" itemprop="dateCreated datePublished" datetime="2023-04-02T20:02:04+00:00">2023-04-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2023-06-24 15:58:45" itemprop="dateModified" datetime="2023-06-24T15:58:45+00:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/embed-linux/" itemprop="url" rel="index"><span itemprop="name">embed linux</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2023/04/02/make-debian-bullseye-images-for-rock960c/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2023/04/02/make-debian-bullseye-images-for-rock960c/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>rock960 是一块不太常见的 96boards 规范得的 rk3399 单板，目前厂家已经不维护了（email咨询得知）.</p>
<p>不过还好他们邮件给了可以下载最新固件的地址 sd-card-images , 下载下来发现是 sd card 用的镜像, 所以需要这里说下怎么制作emmc 版本镜像</p>
<p>单需要稍微处理以下就可以得到更新的 debian 固件</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.96boards.org/product/rock960/">板子官网</a></li>
</ul>
<h2 id="刷入默认的-emmc-镜像"><a href="#刷入默认的-emmc-镜像" class="headerlink" title="刷入默认的 emmc 镜像"></a>刷入默认的 emmc 镜像</h2><p>从这里下载最更新的 rock960c emmc 镜像 <a target="_blank" rel="noopener" href="https://www.96boards.org/documentation/consumer/rock/downloads/debian.md.html">https://www.96boards.org/documentation/consumer/rock/downloads/debian.md.html</a></p>
<p>下载完, 先来重新刷新一下板子的 emmc 镜像. (如果已经刷好镜像, 这里就没必要继续, 直接跳到下个章节</p>
<p>首先通过常规方式， 进入 maskroom 模式。</p>
<blockquote>
<p>具体过程省略</p>
</blockquote>
<p>通过 <code>RKDevTool_Release_v2.86</code> 把最基本的 debian9 镜像写入 <code>emmc</code>， 完成基础版本的刷入。</p>
<p>以下是需要的配置的分区地址</p>
<ul>
<li>0x0 loader.bin – 这个 loader 负责引导进入分区刷写模式，每次刷入系统都需要加上0x0 gpt.image – 完整镜像，包含了 boot 等5个分区， 必须从 0 开始写入</li>
</ul>
<h2 id="通过二次刷写-对-emmc-进行系统升级"><a href="#通过二次刷写-对-emmc-进行系统升级" class="headerlink" title="通过二次刷写, 对 emmc 进行系统升级"></a>通过二次刷写, 对 emmc 进行系统升级</h2><p>从 <a target="_blank" rel="noopener" href="https://sd-card-images.johang.se/boards/rock960.html">https://sd-card-images.johang.se/boards/rock960.html</a> 这里可以下载到 rock960 的更新版本 debian 镜像。</p>
<blockquote>
<p>这里只下载debian-bullseye-arm64-iey4ku.bin.gz , boot-rock960.bin.gz 不用下载</p>
</blockquote>
<p>通过执行 <code>7z x debian-bullseye-arm64-iey4ku.bin.gz</code>, 解压后将得到 ext4.img， 这是Debian 的 rootfs 根目录分区</p>
<p>从官方手册里 rootfs 的写入命令</p>
<pre class="language-none"><code class="language-none">rkdeveloptool wl 262144 rootfs.img</code></pre>

<blockquote>
<p>这里 262144 是十进制， 换算成16进制就是 0x00040000</p>
</blockquote>
<p>再次进入 <code>mask room</code> 模式</p>
<p>按以下地址刷入 <code>rootfs</code> 镜像文件</p>
<ul>
<li>0x0 loader.bin – 每次更新<code>loader</code>都需要放在首位</li>
<li>0x00040000 ext4.img - 因为只是覆盖 <code>rootfs</code> ，需要写上正确的偏移地址</li>
</ul>
<p>完成刷入之后， 重启得到一个全新版本的 debian 11.</p>
<h2 id="接入网络并安装更多包"><a href="#接入网络并安装更多包" class="headerlink" title="接入网络并安装更多包"></a>接入网络并安装更多包</h2><p>由于 sd-card-images 的镜像非常小， 这里需要先通过网络安装常用的 deb 包。</p>
<p>我是通过usb 以太网转接器接入并安装 network-manager 得到无线接入能力。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">apt install sudo iproutes apt-utils fdisk network-manager vim zsh screen</code></pre>

<p>顺便加个新用户</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">useradd -m -G sudo -s &#x2F;bin&#x2F;sh rock960 
password rock960</code></pre>

<p>安装完 network-manager，通过 nmtui-connect 就可以通过 TUI 方便地连上无线了。 root 分区容量扩容</p>
<p>ext4.img 刷入完毕，root 分区的可用容量仅2G， 而 rock960c 的 emmc 容量是 16G， 这里需要通过 resize2fs &#x2F;dev&#x2F;mmcblk1p5 命令完成根分区的自动扩容。 </p>
<blockquote>
<p>就目前的进展而言, 这种安装方式并不是很方便, 后续有空再提供安装基础工具包的镜像<br>在附录中有已经合并好的 EMMC 镜像. 后续发出制作教程.</p>
</blockquote>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>成品镜像 root password: iey4ku</p>
<p><a target="_blank" rel="noopener" href="https://github.com/hitsmaxft/rock960-debian-images/releases/tag/rock960c_debian_bullseye-arm64-iey4ku-pre1">rock960c_debian_bullseye-arm64-iey4ku-pre1</a></p>
<p>github 项目地址</p>
<p><a target="_blank" rel="noopener" href="https://github.com/hitsmaxft/rock960-debian-images">https://github.com/hitsmaxft/rock960-debian-images</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://io.bhe.ink/2015/04/24/how-to-understand-object-oriented-programming/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bhe Hongtyu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bhe's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Bhe's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/04/24/how-to-understand-object-oriented-programming/" class="post-title-link" itemprop="url">如何理解面向对象编程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2015-04-24 15:00:27" itemprop="dateCreated datePublished" datetime="2015-04-24T15:00:27+00:00">2015-04-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2023-06-24 15:58:45" itemprop="dateModified" datetime="2023-06-24T15:58:45+00:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a>
        </span>
          ، 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/PL/" itemprop="url" rel="index"><span itemprop="name">PL</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2015/04/24/how-to-understand-object-oriented-programming/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/04/24/how-to-understand-object-oriented-programming/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>总算来谈下这个烂大街的话题了。</p>
<p>面向对象一般会谈继承封装多态，但列举一门理论具备什么特征并不能帮助程序员合理地应用这门理论。</p>
<p>在传统面向数据和过程的编程方式中， 我们关心的东西有</p>
<ul>
<li>特定结构的数据</li>
<li>针对数据定义的行为</li>
</ul>
<pre class="language-c" data-language="c"><code class="language-c">struct &#123;&#125; A;
void function act(A a);</code></pre>

<p>实话说，这样的编程手段对于解决问题本身已经够用了。</p>
<p>但对于现代化的软件工程项目，为了更好地解决开发效率与开发成本等问题，<br>我们需要引入一种更加有效的描述方式。使得开发任务更加顺畅， 开发成本能够有效降低。</p>
<blockquote>
<p><code>java</code> 界似乎在远古时期宣扬了一种基于 <code>class</code> 的编程方式，并将这种行为称作 <code>oop</code> 的有效实践。<br>而我们知道， 那端时期 <code>java</code> 界所宣扬的从来就没几个是靠谱的。</p>
</blockquote>
<p>首先要摒弃所谓的 <code>class</code> 方式就是面向对象。<br>即使是 <code>javascript</code> 这种基于原型的编程语言，也是满足面向对象原则的。</p>
<p>只是纯粹描述数据本身的东西， 我们称之为 <code>struct</code>（结构体）, 它具备了类型和实例两个内容。<br>而面向对象，则需要在结构体之上，增加一个可以描述行为的方式， 这种方式一般叫做 <code>method</code> (方法)<br>这里方法虽然看起来和 <code>function</code> 类似， 但是它是提供了数据绑定的， 而函数只和输入输出相关，不关心状态。</p>
<p>这个东西从实现上，仅仅是个手法而已，和上文所提到的结构体和函数的接合可以达到同样的目的。<br>现代化的编程语言，正是通过这样的变换手法，优化编程的模型而提高生产力的。</p>
<p>使用面向对象方式编程的开发者，关注的是某一个对象，它所具备的行为（method）。</p>
<p>好吧，因为类型的扩散，我们还是得考虑多种类型之间的交互， 和前面说的 <code>函数 + 结构体</code> 的方式，<br>差别并不大。<br>为了优化这中情况，程序员能做到的无非就是简化传入参数中的类型，尽量使用平坦的数据类型.</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">Name n &#x3D; new Name(&quot;John&quot;);
Person p &#x3D; new Person();
p.setName(n);
p.sayName();</code></pre>

<p>上面的这个例子里， 我们倾向于认为 <code>Name</code> 是一个简单的类型， 而 <code>Person</code> 则是一种具有复杂行为的<br>高级类型。<br>但是，也正是面向对象语言提供的便捷手段，可以通过 <code>封装</code> 手段解决这个问题。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">&#x2F;&#x2F;JhonPerson extends Person
Person jp &#x3D; new JhonPerson();
jp.sayName();</code></pre>

<p>面向对象的本质在于 <code>消息传递</code>, <code>方法调用</code> 不过是类 <code>java</code> 语言中的一种实现。<br>为了简化开发任务， 通过扩展组合等手段， 可以轻易地将复杂行为封装到新类型中，但是提供了相同的接口。</p>
<p>这个例子中， 我们可以体验到面向对象编程中的封装和多态.<br>封装重用了数据， 而多态重用了行为.</p>
<p>面向对象语言过度地提到继承, 似乎所有关联任务都可以通过 <code>extends</code> 来解决。<br>而我们知道，对象之间的关联关系， 扩展基类意味着需要继承行为和数据,是一种垂直的继承。<br>为了打破这种限制， 提供能够横向扩展的能力， <code>java</code> 引入了 <code>接口</code> ，设计模式则提到了 <code>组合</code>.</p>
<p>前面提到，方法是一种和类型绑定的行为，如果只是垂直的单继承体系，多态只能在继承类型之间实现。<br>为了能够满足不同类型之间能够完善地支持多态，接口的引入解决了这个问题，但是，事情并没有能够完美地结束。</p>
<p>在 <code>java</code> 和其他类似语言中，由于函数并不是语言中的第一公民，接口仍然是一个具体的类型，只不过进行了一次间接的多继承.<br>到这里， 我们还是没能够得到我们希望的， 完全基于行为的多态。</p>
<p>在动态语言中，方法的调用是动态进行的，近似于在运行时直接查找同名方法，因此不存在这个问题。<br>而在静态语言中实现了类似行为的有 <code>go</code> , 虽然最终因为缺少泛型而导致了 <code>interface &#123;&#125;</code> 满天飞。</p>
<p>好不容易脱离了类型和方法的限制，又回到了如何解决方法和参数类型之间的绑定关系.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://io.bhe.ink/2015/04/18/routing-with-nginx-basic-rewrite-directives/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bhe Hongtyu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bhe's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Bhe's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/04/18/routing-with-nginx-basic-rewrite-directives/" class="post-title-link" itemprop="url">nginx 路由杂谈 - rewrite 指令与重定向</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2015-04-18 11:22:40" itemprop="dateCreated datePublished" datetime="2015-04-18T11:22:40+00:00">2015-04-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2023-06-24 15:58:45" itemprop="dateModified" datetime="2023-06-24T15:58:45+00:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/etc/" itemprop="url" rel="index"><span itemprop="name">etc</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2015/04/18/routing-with-nginx-basic-rewrite-directives/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/04/18/routing-with-nginx-basic-rewrite-directives/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>在书写 nginx 路由规则的时候， 得保证规则配置的规范， 否则维护起来成本很高。<br>本文简要地讨论了在 rewrite 模块的基础实现的简单路由规则，并解释了常用指令的使用细节。</p>
</blockquote>
<h2 id="rewrite-与-location"><a href="#rewrite-与-location" class="headerlink" title="rewrite 与 location"></a>rewrite 与 location</h2><p>首先，这是一个不完整 nginx 虚拟主机配置:</p>
<pre class="language-none"><code class="language-none">service &#123;
    root &#x2F;service&#x2F;http;
    index index.php;

    rewrite ^&#x2F;api&#x2F;(.*)+ &#x2F;index.php?app&#x3D;api&amp;method&#x3D;$1 break;
    rewrite ^&#x2F;index.php&#x2F;(.*)+ &#x2F;old_api_warning.html break;

    location &#x2F; &#123;
        return 200 &quot;index&quot;;
    &#125;

    location &#x3D; &#x2F;index.php &#123;
        return 200 &quot;index.php&quot;;
    &#125;
&#125;</code></pre>


<p>上面的例子中， 指定的类型可以分为两种。</p>
<ul>
<li><code>server</code>,<code>root</code>, <code>index</code>, <code>location</code> 是 <code>ngx_http_core_module</code> 提供的指令</li>
<li>而 <code>rewrite</code> 则是 <code>ngx_http_rewrite_module</code> 提供的指令之一， 同类的还有常用的 <code>if</code></li>
</ul>
<p>简单地概括， nginx 的处理配置流程如下</p>
<ol>
<li>进行 rewrite 规则匹配，根据命中规则改写 location。</li>
<li>如果没有被其他指令中断并退出， 则进入 location 匹配。</li>
<li>执行匹配成功的 location 区块中的指令。</li>
</ol>
<p>而对于 rewrite 系列指令和 location 指令的安排， 在书写配置的时候， 应该先定义好 location ， 因为 location 是和 nginx 和后端服务沟通的桥梁。<br>再根据 location 的需要， 使用 rewrite 将各种各样用户输入的 url 正确地映射到 对应 locaton ， 由 location 中的 proxy 指令转发给后端。</p>
<p>比如一个常规的 php 站点，有以下类似的 location 配置。</p>
<pre class="language-none"><code class="language-none"># 静态资源
location &#x2F;assets &#123;
    root &#x2F;service&#x2F;http&#x2F;assets&#x2F;;
&#125;
# 入口 php 脚本 位置
location &#x2F;index.php &#123;
    root &#x2F;service&#x2F;http&#x2F;phpsrc&#x2F;webroot&#x2F;;
       # ... 若干 fast-cgi 代理规则
&#125;</code></pre>

<pre><code>注意， 这份配置省略了不必要的指令，能够满足大部分的 php 应用的需要。
</code></pre>
<p>有时候，为了优化 url 的展示，或者兼容旧应用的 url 规则， 只是这么简单的两条 location 配置自然是不够用的。这时候我们可以通过 <code>rewrite</code> 规则进行弥补。</p>
<pre class="language-none"><code class="language-none">rewrite &#x2F;index.html$ &#x2F;app&#x2F;page-default; &#x2F;&#x2F;兼容旧 url

rewrite &#x2F;app&#x2F;page-(.*) &#x2F;index.php?app&#x3D;api&amp;page&#x3D;$1 break;</code></pre>

<p>请注意这两条 <code>rewrite</code> 规则区别的在最后一个 <code>flag</code> 参数 <code>break</code></p>
<pre><code> 可用的 flag 参数还有 `permanent`, `redirect`, `last` 等， 后面分析它们之间的差别。
</code></pre>
<p>多出来的 <code>break</code> 参数作用会使得 <code>rewirte</code> 指令的跳转方式发生变化:</p>
<ul>
<li>没有 flag 的 rewrite 指令完成 location 改写之后 ，继续往下寻找其他 <code>rewrite</code> 规则， 看看有没有符合要求的。如果没有， 那么进入 <code>location</code> 匹配。</li>
<li>带 <code>break</code>， 跳过其他所有 <code>rewrite</code> 规则， 进入 <code>location</code> 匹配</li>
</ul>
<p>这里简单总结一下:</p>
<ul>
<li>如果 某一条 <code>rewrite</code> 规则命中直接转发给后端应用，那么应该加上一个 <code>break</code> 标记。</li>
<li>如果 <code>rewrite</code> 规则起补充作用，还需要其他规则配合完成， 那么不带第三个的 <code>flag</code> 参数。</li>
</ul>
<p>以上说的 <code>rewrite</code> 规则属于 nginx 的内部重定向规则， 也就是说， 用户外部看到的 url 依然是他输入的 url ， 而转给后端应用的 <code>$uri</code> ， 则已经是 nginx 改写之后的结果。</p>
<p>如果需要进行显式地外部重定向， 需要借助 <code>redirect</code> , <code>permanent</code> 这两个 flag 进行 302 和 301 重定向.<br>它的行为和 <code>break</code> 类似， 区别在于 nginx 会中断流程， 通过 http 请求告诉用户端进行重定向，<br>也就是这次请求不需要进过后端服务， 由 nginx 全职负责。</p>
<p><code>rewrite /error.html$ /error2.html redirect;</code></p>
<h3 id="break-和-last-区别"><a href="#break-和-last-区别" class="headerlink" title="break 和 last 区别"></a>break 和 last 区别</h3><p>这两个 flag 都会中断当前 rewrite 流程， 不再继续匹配后续的 rewrite 指令。</p>
<p>wiki 上是这么写的</p>
<blockquote>
<p>stops processing the current set of <code>ngx_http_rewrite_module</code> directives and starts a search for a new location matching the changed URI</p>
</blockquote>
<p>如果是在 <code>server</code> 的顶级部分， 那么它们的作用是相同， 跳过剩下的 rewrite 指定， 进入 location 匹配。<br>如果 rewrite 是在 <code>server</code> 区块顶级 if 内部， 和直接放在 server 下级的  rewrite 行为是一致的。</p>
<pre class="language-none"><code class="language-none">server &#123;
    rewrite &#x2F;error1.html &#x2F;error.html break;
    rewrite &#x2F;error2.html &#x2F;error.html last;

    if ( $arg_version &#x3D; &quot;1.1&quot; ) &#123;
        rewrite &#x2F;error3.html &#x2F;error.html break;
    &#125;

    location &#x3D; error.html &#123;
    &#125;
&#125;</code></pre>

<p>以上的 rewrite 的跳转行为是相同的， 进入 location 匹配流程。</p>
<p>而两者的区别， 在于当 rewrite 指令存在于 <code>location</code> 区块中时, 见例子</p>
<pre class="language-none"><code class="language-none">location &#x3D; index.php &#123;
    if ( $arg_q  &#x3D; &quot;&quot; ) &#123;
        rewrite &#x2F;index.php &#x2F;error.html last;
    &#125;
&#125;
location &#x3D; error.html &#123;
    if ( $arg_test ~&#x3D; &quot;&quot; ) &#123;
        rewrite &#x2F;error.html &#x2F;error-test.html break;
    &#125;
&#125;
</code></pre>

<p>第一个 location , 如果 <code>q</code> 参数为空， 那么将展示错误页面。</p>
<p>第二个 location ， 如果 <code>test</code> 参数不为空， 通过 rewrite 规则，使用另外一个 error-test.html,<br>但 location 不变</p>
<pre><code>注意， 这里并没有一个 `location = error2.html` 的匹配规则
</code></pre>
<p>从这个 case 的结果， 可以明显得区分两个指令之间的细微差别</p>
<ul>
<li>last 跳出 location 块， 重新进行 location 匹配</li>
<li>break 跳过 location 下的后续 rewrite 规则， 执行其他指令。</li>
</ul>
<p>所以 last 的特殊在于重新进行 location 匹配，  这也就是为什么会从</p>
<p><code>locaton = index.php</code></p>
<p>转向</p>
<p><code>locaton = error.html</code></p>
<p>所以一般情况下， 使用 <code>break</code> 指令会相对安全， 不会造成循环重定向。</p>
<p>比如：</p>
<pre class="language-nginx" data-language="nginx"><code class="language-nginx">location &#x3D; error.html &#123;
    rewrite &#x2F;error.html &#x2F;error.html  break;

    if ($arg_q &#x3D; &quot;&quot;) &#123;
        return 404 &quot;not q&quot;;
    &#125;

    fastcgi_pass 127.0.0.1:9000;
    #其他 fastcgi 配置
&#125;</code></pre>
<pre class="language-nginx" data-language="nginx"><code class="language-nginx">location &#x3D; error.html &#123;
    rewrite &#x2F;error.html &#x2F;error.html last;
    fastcgi_pass 127.0.0.1:9000;
&#125;</code></pre>

<p>第一个例子，完成了 rewrite 指令之后，break 指令使得后续的其他 rewrite 规则失效, 接着进行 proxy.<br>第二个例子会导致不断地进行 location 匹配， 最终导致 nginx 返回 500.</p>
<p>返回结果是这样的：</p>
<pre class="language-none"><code class="language-none">HTTP&#x2F;1.1 500 Internal Server Error
Server: nginx&#x2F;1.6.3
Date: Sat, 18 Apr 2015 12:10:49 GMT
Content-Type: text&#x2F;html
Content-Length: 192
Connection: close</code></pre>

<pre><code>注：nginx 会记录同一条 rewrite 规则的执行次数，如果超过10次，将自动触发 500 进行自我保护。
</code></pre>
<p><strong>小结</strong></p>
<p>这里构造了两组例子用来说明 <code>last</code> 和 <code>break</code> 两个 flag 参数行为上的不一致。<br>并不是说 rewrite 规则在  server 和 location 上下文中的行为不一致， 而是他们的行为特征很容易造成误解。</p>
<p>两者的本质区别在于是否<strong>重新</strong>进行 <code>location</code> 匹配，所以当在 location 上下文 进行 last rewrite时。<br>对于不熟悉 rewrite 指定的其他人容易造成误解。</p>
<p>所以还是前文所提到的观点， 尽可能地将 rewrite 和 location 离开来。 在 location 中进行 rewrite， 容易造成重定向问题。</p>
<pre><code>由于 rewrite 模块的 `rewrite` 和 `if` 指令会使得 nginx
的路由规则出现较多的逻辑和分支跳转， 在维护性上是比较糟糕的，
并不推荐过多地进行使用， 本文只是从行为和特性上分析了这些指令，
并不代表支持过度使用 rewrite 指令。
</code></pre>
<h2 id="return-指令的应用"><a href="#return-指令的应用" class="headerlink" title="return 指令的应用"></a>return 指令的应用</h2><p>在 <code>rewrite</code> 模块中， 有一条非常有用的指令 <code>return</code>, 用于直接返回客户端指定的状态码。<br>甚至支持指定文本内容和url， 相比起使用 <code>rewrite</code> 指令302进行曲线救国，要简便地多。</p>
<pre class="language-none"><code class="language-none">location &#x3D; &#x2F;index.php &#123;
  if ( $arg_q &#x3D; &quot;&quot; ) &#123;
    return 302 &#x2F;page_not_found.html;
  &#125;

  if ( $arg_id &#x3D; &quot;&quot; ) &#123;
    return 404 &quot;page not found&quot;;
  &#125;
  return 200 &quot;hello&quot;;
&#125;</code></pre>

<p>对于常规的基于 url 提供服务的应用， 基础的 rewrite 指令配合已经足够完成大部分任务。</p>
<p>下一篇文章再聊聊基于条件，变量和更加复杂的上下文, 完成进行路由规则匹配.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://io.bhe.ink/2015/04/11/php-pro-work-with-weak-type/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bhe Hongtyu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bhe's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Bhe's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/04/11/php-pro-work-with-weak-type/" class="post-title-link" itemprop="url">PHP Pro : 动态类型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2015-04-11 16:19:44" itemprop="dateCreated datePublished" datetime="2015-04-11T16:19:44+00:00">2015-04-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2023-06-24 15:58:45" itemprop="dateModified" datetime="2023-06-24T15:58:45+00:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming-language/" itemprop="url" rel="index"><span itemprop="name">programming language</span></a>
        </span>
          ، 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming-language/php/" itemprop="url" rel="index"><span itemprop="name">php</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2015/04/11/php-pro-work-with-weak-type/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/04/11/php-pro-work-with-weak-type/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="为什么-php-这么流行"><a href="#为什么-php-这么流行" class="headerlink" title="为什么 php 这么流行"></a>为什么 php 这么流行</h2><p>php 的流行已经不用再提及了， 那么， php 具有哪些优点使得它如此流行呢？</p>
<ul>
<li>接近 c(&lt;5.2) 和 java (~&gt;5.3.8) 的语法</li>
<li>动态类型， 编码成本极低</li>
<li>特定任务所需的基础库完备</li>
</ul>
<p>优点 1 就不多说了， 用的人都知道。基础的 <code>function</code> 和 <code>class</code> 语法都极其相似。<br>优点 3 涉及的话题很多，暂时不进行展开, 这里重点聊下 php 中的动态类型.</p>
<h2 id="php-和-类型"><a href="#php-和-类型" class="headerlink" title="php 和 类型"></a>php 和 类型</h2><p>先看一组普通的 PHP 语句：</p>
<pre class="language-php" data-language="php"><code class="language-php">class A&#123;&#125;; &#x2F;&#x2F;定义一个简单的 class A
$a &#x3D; 1;
$a &#x3D; 1.1;
$a &#x3D; &quot;A&quot;;
$a &#x3D; new $a(); &#x2F;&#x2F;类的名字都是直接计算出来的
$a &#x3D; function() &#123; return 1; &#125;; &#x2F;&#x2F;你没看错， 这是匿名函数， php 中叫闭包。</code></pre>

<p>从上可以看到的 php 语句的两个重要特点</p>
<ul>
<li>可以给一个变量名赋上随便哪种值，随便什么类型，什么时候，重复赋值也行。</li>
<li>变量名以 <code>$</code> 开头， 后面会聊为什么这里有一个 <code>$</code></li>
</ul>
<p>这一点让 php 开发者写代码的时候非常轻松。很多东西都不需要考虑。这也就是为什么 php 容易上手。</p>
<p>接下来是一个基础的函数定义代码:</p>
<pre class="language-php" data-language="php"><code class="language-php">function someFunc( $a &#x3D; 1) &#123; &#x2F;&#x2F;一个带默认值的参数 $a
	if ($a &#x3D;&#x3D;&#x3D; 2 || $a &#x3D;&#x3D;&#x3D; 1) &#123; &#x2F;&#x2F; int 类型的严格判断
		return  $a+1;
	&#125; else if (is_array($a)&amp;&amp; isset($a[0]) ) &#123; &#x2F;&#x2F; 数组类型
		return $a[0];
	&#125; else &#123;
                return &quot;$a is unknown&quot;;
        &#125;
&#125;;</code></pre>
<p>这里我们看到， php 的动态性不仅体现在语句上， 函数的定义的参数和返回值也是没有类型的。 对于 php 而言， 返回值是 <code>int</code> 或者 <code>void</code> （在 php 里应该认为是 null） 类型， 在函数定义中没有区别，参数也是。</p>
<pre><code>所以用 php 写出无法维护的代码是轻而易举的事情。
</code></pre>
<p>在实际使用过程中， php 开发者经常干的一件事情是把函数的返回值打印出来，看下数组结构， 找到自己需要的内容。再接着写代码.</p>
<pre><code>默认情况下，php 的函数和类型都是全局的， 5.3 中引入的命名空间改善了这一点。
</code></pre>
<p>当然, 例子中的做法会让使用这个函数的人很头疼， 除非是非常常用以至于用户不可能误解的接口，否则别这么做.</p>
<pre><code>jQuery 的 $() 是一个很好的例子，很多人认为是很反人类的设计.
但是显然它的用户觉得用起来很爽
</code></pre>
<p>代码中的 <code>!empty($a)</code> , 这个也是很常用的技巧， 用于判断一个变量是不是 <code>null</code>, 空字符串， <code>False</code> ，空数组， 等等等等(当然包括了变量不存在，数组下标和字段 key 不存在等等)， 也就是直觉中所有的空值都会命中，很方便不是吗。</p>
<p>php 进行真假值判断时， 会尽可能地进行类型传唤，除了数字类型和 null， 字符串也会尽可能地转换成数字再转换到 true、false。甚至自定义类型，也可以通过实现特殊接口， 支持 <code>empty</code> 操作。 </p>
<blockquote>
<h3 id="empty-的陷阱"><a href="#empty-的陷阱" class="headerlink" title="empty() 的陷阱"></a>empty() 的陷阱</h3><p>针对字符串类型进行 <code>empty()</code> 操作，比如 <code>&quot;0   &quot;</code>， 和 <code>&quot;0&quot;</code> 在 <code>empty()</code> 中是不一样的， 虽然在 intval 函数中， 它的结果都是 0。 也就是， 只有 <code>&quot;&quot;</code>，<code>&quot;0&quot;</code> 这两个特殊的字符串， 其他长度大于0 的字符串都会认为是非 empty 的。</p>
<p>empy 看起来像是一个普通的库函数， 但是它是一个特殊的指令， 并不是函数调用。类似于 <code>echo</code> 和 <code>isset</code>。 这也留下一个 bug， empty 只能针对左值操作，也就是变量名.<br>而对于表达式，比如 <code>empty(&quot;a&quot;)</code> , 在目前的 php 语法中是不合法的， 必须提前计算结果并赋值给一个临时变量。 这个小小的麻烦，在未来的 php 版本中说不定会优化掉。</p>
</blockquote>
<blockquote>
<h3 id="isset-和-empty-的区别"><a href="#isset-和-empty-的区别" class="headerlink" title="isset 和 empty 的区别"></a>isset 和 empty 的区别</h3><p>isset 只用来判断数组下标或者变量是否为 null 。它不能区分 null 和 变量未定义.<br>对于 <code>$a=array( &quot;a&quot;=&gt; null)</code>, <code>isset($a[&quot;a&quot;])</code> 和 <code>isset($a[&quot;b&quot;])</code> 都返回 <code>false</code>.</p>
<p>在 php 中， 不存在是一个模糊的定义，和 null 几乎是等同的。千万不要在代码中依赖一个变量是否定义这种模糊的条件， 这种奇葩的行为只有 javascript 才会关心, 毕竟我么谈的是动态类型语言, 存在感这种东西太弱了。</p>
<p>然而， php 从 c 中抄来的常量定义 define(“A”, a), 是可以用 defined(“A”) 进行判断的.<br>比如 <code>defined(&quot;DEV_MODE&quot;)</code> 判断应用是否运行在开发模式下.</p>
</blockquote>
<pre><code>关于 isset 和 empty 后续的面向对象章节中会谈到。
</code></pre>
<p>在静态类型语言的使用者眼里， php 大概就是一种到处都是 object 和 强制转型的及其不安全的语言了。</p>
<h3 id="又爱又恨的数组"><a href="#又爱又恨的数组" class="headerlink" title="又爱又恨的数组"></a>又爱又恨的数组</h3><p>Array 应该是 php 使用频繁的基础类型了。 也就是它导致了 ide 几乎没办法正确地分析代码中函数返回值和参数的正确性, 因为一切行为都因为 array 的存在而过于灵活。</p>
<p>在 php 中， 数组和字典（或者说hashmap）, 是混合存在的， 都叫 array。 这个混杂的类型，在处理 key 为数组的hash 数据时，很容易埋下 bug。</p>
<p>相比之下，javascript 还是严格地划分了 array 和 object 之间的区别。</p>
<h3 id="使用-array-模拟-struct"><a href="#使用-array-模拟-struct" class="headerlink" title="使用 array 模拟 struct"></a>使用 array 模拟 struct</h3><p>在实际使用中， 针对需要返回复杂结果，但又不需要进行面向对象的包装时，习惯使用 array 做为返回值， 作为 <code>struct</code> 的替代用法.</p>
<pre class="language-php" data-language="php"><code class="language-php">
function someFunc2() &#123;
	return array( &quot;a&quot; &#x3D;&gt; 1, &quot;b&quot; &#x3D;&gt;2 );
&#125;

$a &#x3D; someFunc2(); 
$b &#x3D; $a[&quot;a&quot;];</code></pre>

<p>或者使用 array 做为参数， 避免函数的参数过多带来的麻烦。相对于使用 call_user_func 模拟函数调用要更加自然方便。</p>
<p><code>$c = someFunc3( array( &quot;a&quot; =&gt; 1, &quot;b&quot; =&gt; 2));</code></p>
<p>这里应该说， php 的动态类型特别发挥地淋漓尽致， 虽然可能很多开发者并没有意识到这点， 但是不要紧，这并不妨碍他们用最舒适的方式使用 php。</p>
<p> php 开发者在写代码过程中， 心里只要了解一个函数、方法的作用，剩下的就是填充合适的参数和获取返回值，用 empty， isset 等函数进行判断是否空返回值。</p>
<h2 id="PHP-和"><a href="#PHP-和" class="headerlink" title="PHP 和 $"></a>PHP 和 $</h2><p>和同样是动态类型的语言 javascript 相比， php 有什么特点呢？我能想起来的最显眼的区别， 就是 php 的变量名必须有一个 $ 符号。</p>
<pre><code>当然，这不过是当年从 perl 遗传下来的。
</code></pre>
<p>那么这个 <code>$</code> 符号， 除了必须写上，还有什么实际用途吗？</p>
<pre class="language-php" data-language="php"><code class="language-php">echo &quot;$a is b&quot;;</code></pre>

<p>哦, 原来如此。<code>$</code> 在输出字符串的过程中用于定位字符串中的变量，在输出的过程中会替换为实际的变量内容。</p>
<pre><code>对于 php 而言， “” 风格的字符串意味着需要进行变量的替换， 而 ‘’ 则说明直接输出内容就行了。
这个原则甚至适用与数组的 key .
</code></pre>
<p>如果如果变量名和后续内容没有空格等区分，那么 <code>&quot;$&#123;a&#125;isb&quot;</code> , 通过加大括号就可以解决了。</p>
<p>这样连数组类型也支持了  </p>
<p><code>echo &quot;$&#123;a[0]&#125;isb&quot;</code></p>
<p>也就是</p>
<p><code>&quot;$a is b&quot;</code> 等价于 <code>$a . &quot;is b&quot;</code></p>
<pre><code>注: 在 php 中， `.` 英文句号用于连接字符串.
其他语言中常用的 `+` 加号
</code></pre>
<p>总之， php 的约束很弱，可以很灵活地使用，也很容易失控，这也就是为什么 php 构建大型系统很困难。除了性能问题， 还存在对使用者的约束很弱。</p>
<p>但同时也存在好处， 动态类型和宽泛的约束，使得框架的实现上灵活， 可以轻松实现非常强大的特性，（后面在面向对象和类加载中会谈到）毕竟 php 开发者也习惯了基于约定编程的，只要团队不大，通过开发约定也可能解决这个问题。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://io.bhe.ink/2014/12/18/notes-about-apache-nio-client-source-code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bhe Hongtyu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bhe's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Bhe's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/12/18/notes-about-apache-nio-client-source-code/" class="post-title-link" itemprop="url">Apache nio client 源码阅读笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2014-12-18 07:34:29" itemprop="dateCreated datePublished" datetime="2014-12-18T07:34:29+00:00">2014-12-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2023-06-24 15:58:45" itemprop="dateModified" datetime="2023-06-24T15:58:45+00:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a>
        </span>
          ، 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2014/12/18/notes-about-apache-nio-client-source-code/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/12/18/notes-about-apache-nio-client-source-code/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-部分主要类型功能简介"><a href="#1-部分主要类型功能简介" class="headerlink" title="1. 部分主要类型功能简介"></a>1. 部分主要类型功能简介</h2><p><strong><code>org.apache.http.impl.nio.client.HttpAsyncClients</code></strong></p>
<p>它是一个比较接近业务层的介面, 提供一系列工厂方法, 用于构造 启动对 <code>HttpAsyncClient</code> 的构造和配置工作</p>
<p><strong><code>org.apache.http.impl.nio.client.HttpAsyncClientBuilder</code></strong></p>
<p>工厂方法创建buidler 用于构造具体的client.</p>
<p>从属性可以看出来, 使用策略模式, 支持各种类型策略的注入, 线程工厂, http接受&#x2F;处理回调函数等等, cookie&#x2F;auth 等http协议的内容也在这个地方处理.</p>
<p>它的 <code>build</code> 方法生成  <code>org.apache.http.impl.nio.client.CloseableHttpAsyncClient</code> 的子类型</p>
<p><strong><code>org.apache.http.impl.nio.client.InternalHttpAsyncClient</code></strong></p>
<p>默认的 HttpAsyncClient , 使用之前需要调用 start 方法.</p>
<p>http 请求任务通过 execute 方法提交, 其实现原理是<br>生成一个fureture对象用作和用户沟通,<br>再生成一个 <code>org.apache.http.impl.nio.client.DefaultClientExchangeHandlerImpl</code> 实例, 由它启动和 io loop 的数据交换<br>最后把 future 对象返回给用户层</p>
<p><strong><code>org.apache.http.impl.nio.client.DefaultClientExchangeHandlerImpl</code></strong></p>
<p>InternalHttpAsyncClient 会默认调用他的start方法.</p>
<p>在 start() 中, exec.prepare 负责向 stat 中填充数据和 request 配置</p>
<p>requestConnection() 向 connection manager 发起 connection , 并向他注册了一个 future callback, 意味着, conn manager 会向 ExchangeHandler 回调事件, 从而间接地向用户层发起回调.</p>
<p><strong><code>org.apache.http.nio.conn.NHttpClientConnectionManager</code></strong></p>
<p>负责接管 client 提交的http请求</p>
<p>关于接受请求的方法签名如下</p>
<pre class="language-java" data-language="java"><code class="language-java">Future&lt;NHttpClientConnection&gt; requestConnection(
        HttpRoute route,
        Object state,
        long connectTimeout,
        long connectionRequestTimeout,
        TimeUnit timeUnit,
        FutureCallback&lt;NHttpClientConnection&gt; callback);</code></pre>

<ul>
<li><p>HttpRoute 和请求的 ip 相关, 有一个相关的参数 MaxRequestPerRoute, 意思就是对同一个主机发起的最大连接数</p>
</li>
<li><p>connectTimeout tcp 等待建立 connection 的等待时间, 对方主机的tcp通道建立需要一定的时间</p>
</li>
<li><p>connectionRequestTimeout 表示排队等待 connection 的时间具体参考下文的 lease time</p>
<p>  ps1: connection 可以认为是一个保持着的长连接资源, 也就是 tcp 通道<br>  ps2: route 里面如果配置了 proxyhost(http代理), 那么这时候就起作用了</p>
</li>
</ul>
<p>释放请求 releaseConnection, 这是真的将一个 connection 实例从 pool里拿出来, 中止链接, 回收实例</p>
<p>所以它完成的事情也不多, 就是向 pool 里注册和释放 connection</p>
<p><strong><code>org.apache.http.impl.nio.conn.CPoolProxy</code></strong></p>
<p>上文提到的 pool , 连接池代理,通过 lease 方法注册新的请求</p>
<ol>
<li><p>首先 创建一个 org.apache.http.nio.pool.LeaseRequest#LeaseRequest 实例, 持有传入的参数</p>
<ul>
<li>上文提到的 connectionRequestTimeout , 这里叫 lease time , 也就是 lease request 的 dealine</li>
</ul>
</li>
<li><p>在 processPendingRequest 中, 检查deadline ,如果到了, requestTimeout 触发, 触发TimeoutException (注意类型)</p>
<ul>
<li>也就是说, lease request 创建完毕, 发现已经到dealine ,那么就不向 pool 索取 connection 了, 直接退出</li>
</ul>
</li>
<li><p>接着向 routeToPool 和 route 对应的 connection pool (org.apache.http.nio.pool.RouteSpecificPool)  , 如果没有的话, 发起一个新的pool.</p>
</li>
<li><p>接着从 pool 中索取一个 connection (org.apache.http.nio.reactor.SessionRequest) , 如果没有, 创建新的 pool , 将 socketTimeout 配置进去</p>
<p> 创建新的connection , 需要检查route对应的connection数量是否达到上限.<br> 对于拿到的新的 connection, 将上文所提到的 requestTimeout 作为 connection 的 connectionTimeout.</p>
</li>
</ol>
<p><strong><code>org.apache.http.impl.nio.reactor.DefaultConnectingIOReactor</code></strong></p>
<p>nio 反应堆的默认实现, 继承于 org.apache.http.impl.nio.reactor.AbstractMultiworkerIOReactor , 负责发起worker线程, 并维护和 Nio api 之间的交互</p>
<pre><code>worker 的个数在创建 conm 的时候决定.
默认配置中通过 `java.lang.Runtime#availableProcessors` 决定,
也就是 jvm 检测到的当前可用处理器数.
</code></pre>
<h2 id="总结和体会"><a href="#总结和体会" class="headerlink" title="总结和体会"></a>总结和体会</h2><p>关于实践</p>
<ol>
<li>不应该在callback中使用耗时的操作, 这会导致阻塞io线程, 从而降低io部分的工作效率, 成为系统瓶颈.</li>
<li>实际使用中发现，保持长链接的情况下， 存在由于链接到期断开导致刚刚放入连接池的新链接瞬间断开的情况， 这种情况需要按需重新发起链接. 我这边统计到的发生率不超过 0.1%.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://io.bhe.ink/2014/06/15/a-vimers-kbc-poker2-review/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bhe Hongtyu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bhe's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Bhe's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/06/15/a-vimers-kbc-poker2-review/" class="post-title-link" itemprop="url">vimer入手 KBC poker2 数天的感想</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2014-06-15 15:04:53" itemprop="dateCreated datePublished" datetime="2014-06-15T15:04:53+00:00">2014-06-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2023-06-24 15:58:45" itemprop="dateModified" datetime="2023-06-24T15:58:45+00:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/devices/" itemprop="url" rel="index"><span itemprop="name">devices</span></a>
        </span>
          ، 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/devices/keyboard/" itemprop="url" rel="index"><span itemprop="name">keyboard</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2014/06/15/a-vimers-kbc-poker2-review/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/06/15/a-vimers-kbc-poker2-review/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>买来平时写代码用的, archlinux+kde+vim下开发 php 主要应用, 偶尔用用phpstorm和pycharm 看看其他不经常维护的项目.</p>
<p>前几天在这个搜索下6x键机械键盘, 看来看去感觉 poker2 的感觉比较好, 就直接去购了台茶轴的. 以前用的 das, 感觉玩游戏还行, 就是有点吵人, 后来不玩游戏就送人了.所以工作的参考虑下其他人说法, 估计茶轴应该比较合适.</p>
<p>这两天用下来感觉还不错. 手感不错, 相对于笔记本的巧克力键盘稍微键程大了一点点, 熟悉之后也没什么不舒服的.</p>
<p>回到键位的配置上吧, 第一个碰上的问题就是 <code>esc</code> 键, 问题在于 <code>~</code>.</p>
<p>现在要按 <code>shift+fn+esc</code>, 稍微有点困难. 绑定到 <code>pn+esc</code> , 总算稍微方便点.<br>理论上最好的键位应该 shift+esc 贴近原来的使用习惯, 毕竟 <code>`</code> 很少用上.</p>
<p>bash 的 <code>`</code> 反正可以用 <code>$()</code> 替代. 另外通过disp改右 ctrl 为 <code>~</code>, 但是感觉用着比较别扭.</p>
<p>第二问题就是熟悉 fx 改成fn+数字. 平时倒没啥问题, 就是 kwin 的一些快捷键多少会用上 fx 键, 比如 alt+f2. 或者ide里的一些调试工具, fx 还是挺常用的, 用的时候总要稍稍翻译一下.</p>
<p>And, 方向键, 虽玩游戏喜欢用 wasd, 但是用 fn+wasd 操作方向键的方式, 需要适应一下. 通常第一反应还是右手去按右下的按键. 虽然是一个很简单的操作, 着实是成了习惯成自然了.</p>
<p>买的时候附送了6个无刻彩色键帽, 我换掉了 <code>fn</code> <code>win</code> <code>pn</code>, 平时操作的时候比较视觉上方便定位.</p>
<p>毕竟是拿来干活的工具, 暂时没太折腾.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://io.bhe.ink/2014/06/04/some-words-about-the-new-ios/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bhe Hongtyu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bhe's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Bhe's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/06/04/some-words-about-the-new-ios/" class="post-title-link" itemprop="url">新 iOS 杂谈</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2014-06-04 07:28:44" itemprop="dateCreated datePublished" datetime="2014-06-04T07:28:44+00:00">2014-06-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2023-06-24 15:58:45" itemprop="dateModified" datetime="2023-06-24T15:58:45+00:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/etc/" itemprop="url" rel="index"><span itemprop="name">etc</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2014/06/04/some-words-about-the-new-ios/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/06/04/some-words-about-the-new-ios/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>这里对发布会的怨念很大, 发点正能量</p>
<p>这次的 WWDC, 我个人感觉 Apple 是拿出了诚意了, 只是还没正式发布, 结果还不知道怎么样. </p>
<p>大学的时候打工买了台 milestone 2 , 对 android 失望得不得了, 后来就一直是用着 iPhone. 再后来年会中了台 N4, 玩了几天, 发现 android 4.x 是稍微好了点, 但是也没什么吸引力, 就送人了.</p>
<p>我曾经对比过 a 和 i 的区别, 后来我觉得原因就是环境. </p>
<p>iphone 有 App Store 和 iTunes, android 有什么呢? </p>
<p>我个人感觉, iPhone 并不是完美无缺才超越了 Android, 相反, 它很多东西没做好. safari 很一般, App 都是沙箱里孤立的, 记事本之类的系统应用做得也不是太舒服. </p>
<p>在 IOS 8, intent 和 第三方输入法反映了苹果确定在一定程度开放了它的这个操作系统. 但是这是一件顺其自然的事情, </p>
<p>回头说说安卓? 我觉得它早早走上一条不归路, 过于开放, 乱七八糟. 以至于我都不知道怎么用它了.</p>
<p>大排档和高级餐厅的差别, 并不只是相差在价格上, 而是体验, 这时候解决的已经不是温饱问题. 对于一个只需要吃饱的人, 大排档够了, 但瞎 BB 酒店太贵这种心态可不少见.</p>
<p>说实在, 我觉得问题在于, 我希望的手机是好用, 又不费神. 毕竟在这东西花时间又不是工作内容, 没啥回报. 自从买了 kof-i 之后我就再也没买过任何的游戏了, 我也不觉得 iOS 平台能产生游戏性超过任天堂或者索尼的游戏, 就算哪天它把任天堂收购了, 那又怎样.</p>
<p>我只当它是手机, 能胜任移动助理功能, 至于其他的, 已经超出了它所应该拥有的意义了. </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://io.bhe.ink/2014/03/23/asynchronous-programming-with-phpdaemon/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bhe Hongtyu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bhe's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Bhe's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/03/23/asynchronous-programming-with-phpdaemon/" class="post-title-link" itemprop="url">PHPDaemon 异步编程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2014-03-23 19:39:27" itemprop="dateCreated datePublished" datetime="2014-03-23T19:39:27+00:00">2014-03-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2023-06-24 15:58:45" itemprop="dateModified" datetime="2023-06-24T15:58:45+00:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming-language/" itemprop="url" rel="index"><span itemprop="name">programming language</span></a>
        </span>
          ، 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming-language/php/" itemprop="url" rel="index"><span itemprop="name">php</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2014/03/23/asynchronous-programming-with-phpdaemon/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/03/23/asynchronous-programming-with-phpdaemon/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>phpdaemon, 基于异步网络请求的应用服务框架</p>
<p>一直以来, php给人的印象就是一个单进程同步的编程语言, 其魅力在于简单, 直观,<br>学习成本低, 容易上手, 所以市场占有率很高.</p>
<p>流行的php模式, 从几年前的 apache + mod-php, 到今天的nginx + php-fpm,<br>在php编程层面上都是一直的.<br>开发者的开发的代码都是居于”php进程会同步执行所有的代码逻辑之后退出并释放”<br>这么一种假设, 不用考虑多线程的锁问题, 大多数情况下也不用考虑内存泄露.<br>虽然实际情况下, php进程受上层管理界面的影响, 并不是像 cli<br>模式那样执行一次并退出, 但对开发者而言, 其中细节可以忽略.</p>
<p>回到 <code>phpdaemon</code> 本身吧,<br>phpdaemon是一个在event和eio两个pecl扩展之上开发的异步网络框架, 类似于 python<br>中的 tornado , 它采用的单进程单线程异步IO的网络模型,<br>可用于开发异步非阻塞的应用.</p>
<p>前面说 phpdaemon 是单进程单线程的网络模式, 严’意义上讲是指它的worker. phpdaemon<br>以 master + workers 方式运行, master只负责分发任务, 在worker<br>进程才进行请求内容的处理工作.</p>
<p>在 phpdaemon 中, 一个进程中会启用多个服务实例,  每个实例对应一个 appinstance.<br>开发者将不同的处理逻辑封装成为不同的 app, 在异步调度中各司其职.</p>
<p>master 在接受到请求之后, 向 AppResolver 发起查询, Resolve 根据上下文,<br>返回一个对应的应用实例名称. 比如需要返回一个静态文件, 那么可以返回一个<br>FileReader 实例, 实例的Request 方法中完成异步并向客户端输出文件内容.<br>而最常见的任务是返回一个动态页面的内容, 这种类型的任务, 在 phpdaemon 中抽象为<br>HttpRequest 类型.   一个常规cms中的前端和后台界面,<br>可以分装成两个不同的appInstance, 在resolver实现对应的判断逻辑,<br>正确路由到对应的appInstance上, 然后再决定发起哪一个 Request 类型.</p>
<p>这种关系有点像 MVC 框架中的C. 大部分php web 框架的 controller<br>中会包含多个action, 在 phpdaemon 中, <code>PHPDaemon\Core\AppInstance</code><br>可以认为是controller, 而action则对应着 client\Request.</p>
<p>为什么这里要分成 AppInstance 和 Request 两种类型呢?<br>这里涉及到并发环境中的内存管理问题. 常规的php应用是同步的, 从来不考虑这个问题.<br>一个实例最终会被释放, 多个请求之间并没有共享关系. 但是在phpdaemon中,<br>并不是这么回事. worker进程一段时间内一直驻留内存, 需要管理每次请求中用到的资源. </p>
<p>服务器的配置是不变的, 可以常驻内存. 对下层接口的调用结果, 不同任务之间是独立的,<br>所以任务完毕后应该释放掉.   </p>
<p>所以, 在并发环境下, AppInstance 不断生成新的 Request<br>对象处理任务并存储在队列当中, 而 Request 在进行网络请求的时,<br>会交出cpu并进入休眠, 等待io事件将自己唤醒. 当 Request 完成任务并返回结果,<br>AppInstance 将结果返回, 并将该 Request 实例从内存中释放.</p>
<p>上文提到的 Request , 并不是一般认为的 网络请求, 而是对应负责处理网络请求的<br>Service. 那么应用的网络请求又是如何发起的呢?</p>
<p>这里先解释下 phpdaemon 中的 pool 和 connection.</p>
<p>Connection, 顾名思义, 就是php代码中发起的异步网络请求, 比如常见的 curl.<br>在异步请求中, 应用发起很多网络请求, 通过事件进行调度.<br>所以同一时间存在多个网络请求, 只不过有的是活跃状态, 有的挂起等待后端返回.<br>存储和管理这些 Connection 的负责人, 就是 Pool. 这就是常说的连接池.</p>
<p>Java语言中的连接池, 一般通过多线程实现的. 而 PhpDaemon 中的连接池,<br>则是在libevent上实现的单进程单线程异步连接池.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" title="الصفحة التالية" aria-label="الصفحة التالية" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bhe Hongtyu</span>
</div>
  <div class="powered-by">تطبيق الموقع <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/hitsmaxft" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js" integrity="sha256-4mJNT2bMXxcc1GCJaxBmMPdmah5ji0Ldnd79DKd1hoM=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha256-AjM0J5XIbiB590BrznLEgZGLnOQWrt62s3BEq65Q/I0=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"bhehontyublogging","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
